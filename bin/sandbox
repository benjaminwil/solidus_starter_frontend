#!/usr/bin/env bash

set -e

case "${DB}" in
  postgres|postgresql)
    railsdb="postgresql"
    host="${DB_POSTGRES_HOST:-${DB_HOST}}"
    username="${DB_USERNAME}"
    password="${DB_PASSWORD}"
    ;;
  mysql)
    railsdb="mysql"
    host="${DB_MYSQL_HOST:-${DB_HOST}}"
    username="${DB_USERNAME}"
    password="${DB_PASSWORD}"
    ;;
  sqlite|'')
    railsdb="sqlite3"
    ;;
  *)
    echo "Invalid DB specified: ${DB}"
    exit 1
    ;;
esac

extension_name="solidus_starter_frontend"

sandbox_name='sandbox'
sandbox_path="./${sandbox_name}"

rm -f Gemfile Gemfile.lock
bundle init
bundle add rails

rm -rf "${sandbox_path}"
bundle exec rails new "${sandbox_name}" \
  --template='template.rb' \
  --database="${railsdb}" \
  --skip-bundle \
  --skip-git \
  --skip-keeps \
  --skip-rc \
  --skip-spring \
  --skip-test \
  --skip-javascript

if [[ ! -d "${sandbox_name}" ]]; then
  echo 'sandbox rails application failed'
  exit 1
fi

cd "${sandbox_path}"

replace_in_database_yml() {
  if [[ "${railsdb}" == "postgresql" ]]; then
    sed -i.bck "/^  adapter:/a \ \ $1:  $2" config/database.yml
  elif [[ "${railsdb}" == "mysql" ]]; then
    sed -i.bck "s/^  $1:.*/\ \ $1: $2/" config/database.yml
  fi

  if [[ -f config/database.yml.bck ]]; then
    rm -f config/database.yml.bck
  fi
}

if [[ -n "${host}" ]]; then
  replace_in_database_yml "host" "${host}"
fi

if [[ -n "${username}" ]]; then
  replace_in_database_yml "username" "${username}"
fi

if [[ -n "${password}" ]]; then
  replace_in_database_yml "password" "${password}"
fi

RAILS_ENV=test bundle exec rake db:drop db:create

rm ../Gemfile ../Gemfile.lock

echo
echo "ðŸš€ Sandbox app successfully created for ${extension_name}!"
echo "ðŸš€ Using ${railsdb}"

if [[ -n "${SOLIDUS_REPO}" ]]; then
  echo "ðŸš€ Using Solidus repo ${SOLIDUS_REPO}"
fi

if [[ -n "${SOLIDUS_BRANCH}" ]]; then
  echo "ðŸš€ Using Solidus branch ${SOLIDUS_BRANCH}"
fi

echo "ðŸš€ Use 'export DB=[postgres|mysql|sqlite]' to control the DB adapter"
echo "ðŸš€ Use 'export SOLIDUS_BRANCH=<BRANCH-NAME>' to control the Solidus version"
echo "ðŸš€ This app is intended for test purposes."
