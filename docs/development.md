# Solidus Starter Frontend development information
This document aims to give some extra information for developers that are going 
to contribute to our `solidus_starter_frontend` component.

### Testing the extension
First bundle your dependencies (or use [docker](#docker-development)), then run
`bin/rake`. `bin/rake` will default to building the dummy app if it does not
exist, then it will run specs. The dummy app can be regenerated by using
`bin/rake extension:test_app`.

```shell
bin/rake
```

To run [Rubocop](https://github.com/bbatsov/rubocop) static code analysis run:
```shell
bundle exec rubocop
```

When testing your application's integration with this extension you may use its 
factories.
Simply add this require statement to your spec_helper:

```ruby
require 'solidus_starter_frontend/factories'
```

### Running the extension in development

In order to run the extension, you can either 1) run the sandbox script to
generate the sandbox app or 2) add the extension as a gem in a Rails app.

#### Running the sandbox

The sandbox script uses the `solidus_starter_frontend:install` generator to
install the frontend. This is useful when you want to ensure that the generator
is working.

To run this extension in a sandboxed Solidus application, you can run 
`bin/sandbox`. The path for the sandbox app is `./sandbox` and `bin/rails` will 
forward any Rails commands to `sandbox/bin/rails`.

Here's an example:

```
$ bin/rails server
=> Booting Puma
=> Rails 6.0.2.1 application starting in development
* Listening on tcp://127.0.0.1:3000
Use Ctrl-C to stop
```

Default username and password for admin are: `admin@example.com` and `test123`.

#### Running the extension as an engine in a Rails app

You can also run the extension as a engine in a Rails app. This is useful when
you want to automatically see changes in the app without having to rerun the
`solidus_starter_frontend:install` generator.

To run the extension in a Rails app,

##### 1) Create a Rails app

```sh
rails new store
```

##### 2) Add and install Solidus with `solidus_starter_frontend` in the Rails app

Add the following gems. Since we're developing `solidus_starter_frontend`, we're
assuming that you have `solidus_starter_frontend` locally and that you want to
point to the latest versions of the Solidus components and extensions.

```rb
solidus_repo = ENV.fetch('SOLIDUS_REPO', 'solidusio/solidus')
solidus_branch = ENV.fetch('SOLIDUS_BRANCH', 'master')
gem 'solidus_core', github: solidus_repo, branch: solidus_branch
gem 'solidus_api', github: solidus_repo, branch: solidus_branch
gem 'solidus_backend', github: solidus_repo, branch: solidus_branch
gem 'solidus_sample', github: solidus_repo, branch: solidus_branch

gem 'solidus_starter_frontend', path: 'path/to/solidus_starter_frontend'

solidus_auth_devise_repo = ENV.fetch('SOLIDUS_AUTH_DEVISE_REPO', 'solidusio/solidus_auth_devise')
solidus_auth_devise_branch = ENV.fetch('SOLIDUS_AUTH_DEVISE_BRANCH', 'master')
gem 'solidus_auth_devise', github: solidus_auth_devise_repo, branch: solidus_auth_devise_branch
```

Note that `solidus_starter_frontend` has conditional references to
`solidus_auth_devise`, so it's important to place `solidus_starter_frontend`
before `solidus_auth_devise`.

##### 3) Enable `SOLIDUS_STARTER_FRONTEND_ALLOW_AS_ENGINE` environment variable

We're strongly encouraging people to use `solidus_starter_frontend` as a
generator. Thus, if you want to run it as an engine, you'll need to set an
environment variable explicitly stating so.

One way to do this is to set the environment variable within an initializer:

```sh
# config/initializers/solidus_starter_frontend.rb
ENV['SOLIDUS_STARTER_FRONTEND_ALLOW_AS_ENGINE'] = 'true'
```

##### 3) Install Solidus

```sh
bundle exec rails generate solidus:install \
  --auto-accept \
  --user_class=Spree::User \
  --enforce_available_locales=true \
  --with-authentication=false \
  --payment-method=none

bundle exec rails generate solidus:auth:install --auto-run-migrations
```

##### 4) Install the frontend assets

You will need to run `bundle exec rails g solidus_starter_frontend:install` to add the
frontend assets to the existing vendored Solidus manifest files.

##### 5) Run the server

```sh
rails server
```

### Updating the changelog
Before and after releases the changelog should be updated to reflect the 
up-to-date status of the project:
```shell
bin/rake changelog
git add CHANGELOG.md
git commit -m "Update the changelog"
```

### Releasing new versions
Your new extension version can be released using `gem-release` like this:
```shell
bundle exec gem bump -v 1.6.0
bin/rake changelog
git commit -a --amend
git push
bundle exec gem release
```

## Solidus Compare tool
`solidus_compare` is a tool that we created to keep track of the changes made to
[solidus_frontend](https://github.com/solidusio/solidus/tree/master/frontend), 
which we used as source project in the beginning.

It is connected to our CI; when a new PR is opened, if a change is detected on 
Solidus Frontend, the workflow will fail and it will report the files changed.

In that case, it is needed to evaluate those changes and eventually apply them 
to our component. After this step, it is possible to mark those changes as 
"managed".

In practical terms:
- run locally `bin/solidus_compare` in any branch;
- evaluate the diff of the changes shown in the console;
- apply the required changes (if they are useful to the project);
- run `bin/solidus_compare -u` which will update the hashes in the config file;
- commit the changes and check the CI.

The tool internally works in this way:
- configuration file is loaded (`config/solidus_compare.yml`);
- remote GIT source is updated using the parameters provided by the config file;
- compare process is executed and a hash for each file is calculated;
- if they match the hashes saved in the configuration there are no differences.

### Docker development

If you are a docker user you can wake up the project as usual with:

```bash
docker-compose up -d
```

Wait for all the dependencies to be installed. You can check progress with `docker-compose logs -f app`.

Then you can dispatch commands to the `app` container:

```bash
docker-compose exec app bin/rake
```

When running the [sandbox application](#running-the-sandbox), take into account
that you need to bind to `0.0.0.0`. By default, port `3000` is exposed but you
can changed it through `SANDBOX_PORT` environment variable:

```bash
SANDBOX_PORT=4000 docker-compose up -d
docker-compose exec app bin/sandbox
docker-compose exec app bin/rails server --binding 0.0.0.0 --port 4000
```
